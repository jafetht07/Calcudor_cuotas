import tkinter as tk
from tkinter import messagebox
from tkinter import ttk
from PIL import Image, ImageTk

# Garantía Línea Blanca (filtrada desde 24 meses en adelante)
garantia_linea_blanca = {
    24: 22000.0,
    36: 26000.0,
    48: 31000.0,
    60: 34500.0
}

class AplicacionMovil:
    def __init__(self):
        self.ventana = tk.Tk()
        self.ventana.title("Simulador Financiamiento")
        self.ventana.geometry("360x750")
        self.ventana.minsize(320, 620)
        self.ventana.resizable(True, True)

        # Cargar imagen fondo
        try:
            self.imagen_original = Image.open("Fondo.JPEG")
        except Exception as e:
            messagebox.showerror("Error", f"No se encontró la imagen 'fondo.jpg'\n{e}")
            self.ventana.destroy()
            return

        imagen_redimensionada = self.imagen_original.resize((360, 750))
        self.imagen_fondo = ImageTk.PhotoImage(imagen_redimensionada)

        self.label_fondo = tk.Label(self.ventana, image=self.imagen_fondo)
        self.label_fondo.place(x=0, y=0, relwidth=1, relheight=1)

        self.ventana.bind("<Configure>", self.redimensionar)

        # Frame principal
        self.frame = tk.Frame(self.ventana, bg="#ffffff", bd=6, relief="ridge")
        self.frame.pack(padx=20, pady=20, fill="both", expand=True)

        self.crear_widgets()

        self.ventana.mainloop()

    def redimensionar(self, event):
        if event.width > 0 and event.height > 0:
            imagen_redimensionada = self.imagen_original.resize((event.width, event.height))
            self.imagen_fondo = ImageTk.PhotoImage(imagen_redimensionada)
            self.label_fondo.config(image=self.imagen_fondo)
            self.label_fondo.image = self.imagen_fondo

    def crear_widgets(self):
        font_label = ("Arial", 14)
        font_entry = ("Arial", 14)
        font_boton = ("Arial", 16, "bold")

        # Campos principales
        textos = ["Monto de compra:", "Prima:", "Tasa de interés (%):", "Plazo (meses):"]
        self.entradas = []

        for texto in textos:
            lbl = tk.Label(self.frame, text=texto, font=font_label, bg="#ffffff")
            lbl.pack(anchor="w", pady=(10, 2), padx=10)

            ent = tk.Entry(self.frame, font=font_entry, relief="solid", bd=2)
            ent.pack(fill="x", padx=10, pady=(0, 10))
            ent.bind("<FocusIn>", lambda e, widget=ent: widget.config(highlightcolor="#4CAF50", highlightthickness=3))
            ent.bind("<FocusOut>", lambda e, widget=ent: widget.config(highlightthickness=0))

            self.entradas.append(ent)

        self.entrada_compra = self.entradas[0]
        self.entrada_prima = self.entradas[1]
        self.entrada_tasa = self.entradas[2]
        self.entrada_plazo = self.entradas[3]

        # Selección categoría
        lbl_cat = tk.Label(self.frame, text="Categoría del producto:", font=font_label, bg="#ffffff")
        lbl_cat.pack(anchor="w", pady=(10, 2), padx=10)

        self.categoria = tk.StringVar(value="Otro")
        combo_categoria = ttk.Combobox(
            self.frame, textvariable=self.categoria,
            values=["Línea Blanca", "Otro"], state="readonly", font=font_entry
        )
        combo_categoria.pack(fill="x", padx=10, pady=(0, 10))
        combo_categoria.bind("<<ComboboxSelected>>", self.mostrar_garantia)

        # Sección garantía (solo aparece si Línea Blanca)
        self.lbl_info_garantia = tk.Label(
            self.frame, text="Garantía únicamente para Línea Blanca",
            font=("Arial", 12, "italic"), bg="#ffffff", fg="blue"
        )
        self.opcion_garantia = tk.StringVar(value="No")
        self.combo_garantia = ttk.Combobox(
            self.frame, textvariable=self.opcion_garantia,
            values=["No", "Sí"], state="readonly", font=font_entry
        )
        self.combo_garantia.bind("<<ComboboxSelected>>", self.mostrar_plazo_garantia)

        self.lbl_plazo_garantia = tk.Label(self.frame, text="Plazo garantía (meses):", font=font_label, bg="#ffffff")
        self.combo_plazo_garantia = ttk.Combobox(
            self.frame, values=list(garantia_linea_blanca.keys()), state="readonly", font=font_entry
        )

        # Botón calcular
        boton = tk.Button(self.frame, text="Calcular", font=font_boton, bg="#4CAF50", fg="white",
                          activebackground="#45a049", cursor="hand2", command=self.calcular)
        boton.pack(fill="x", padx=20, pady=20)

        # Resultado
        self.resultado = tk.Label(self.frame, text="", fg="green", font=("Arial", 14, "bold"), bg="#ffffff", justify="left")
        self.resultado.pack(pady=10)

    def mostrar_garantia(self, event):
        if self.categoria.get() == "Línea Blanca":
            self.lbl_info_garantia.pack(anchor="w", pady=(5, 2), padx=10)
            self.combo_garantia.pack(fill="x", padx=10, pady=(0, 10))
        else:
            self.lbl_info_garantia.pack_forget()
            self.combo_garantia.pack_forget()
            self.lbl_plazo_garantia.pack_forget()
            self.combo_plazo_garantia.pack_forget()

    def mostrar_plazo_garantia(self, event):
        if self.opcion_garantia.get() == "Sí":
            self.lbl_plazo_garantia.pack(anchor="w", pady=(5, 2), padx=10)
            self.combo_plazo_garantia.pack(fill="x", padx=10, pady=(0, 10))
        else:
            self.lbl_plazo_garantia.pack_forget()
            self.combo_plazo_garantia.pack_forget()

    def calcular(self):
        try:
            monto = float(self.entrada_compra.get())
            prima = float(self.entrada_prima.get())
            tasa = float(self.entrada_tasa.get()) / 100 / 12
            plazo = int(self.entrada_plazo.get())

            monto_financiado = monto - prima
            if monto_financiado <= 0:
                raise ValueError("La prima no puede ser mayor o igual al monto.")

            # Cuota producto
            cuota_producto = monto_financiado * tasa / (1 - (1 + tasa) ** -plazo)

            cuota_garantia = 0
            if self.categoria.get() == "Línea Blanca" and self.opcion_garantia.get() == "Sí":
                try:
                    plazo_garantia = int(self.combo_plazo_garantia.get())
                    valor_garantia = garantia_linea_blanca.get(plazo_garantia, 0)
                    cuota_garantia = valor_garantia / plazo_garantia
                except ValueError:
                    raise ValueError("Debe seleccionar un plazo para la garantía.")

            cuota_total = cuota_producto + cuota_garantia

            self.resultado.config(text=(
                f"Cuota producto: ₡{cuota_producto:,.2f}\n"
                f"Cuota garantía: ₡{cuota_garantia:,.2f}\n"
                f"TOTAL mensual: ₡{cuota_total:,.2f}"
            ))
        except Exception as e:
            messagebox.showerror("Error", f"Datos inválidos: {e}")

if __name__ == "__main__":
    AplicacionMovil()
